<!DOCTYPE html>
<html style="width: 100vw;height: 100vh;">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<!-- 添加 places 库 -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7n-APGM4DbGl9ezhWoz2mf0kxfdGL9Do&sensor=false&libraries=places"></script>
		<script type="text/javascript" src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"></script>
		<style>
			body { margin: 0; padding: 0; }
			#top-bar {
				position: absolute;
				top: 0; left: 0; width: 100vw; z-index: 10;
				background: #fff; display: flex; align-items: center;
				padding: 16px 12px;
				box-sizing: border-box; border-bottom: 1px solid #eee;
				height: 64px;
			}
			#search-input {
				flex: 1;
				padding: 12px 16px;
				font-size: 18px;
				border: 1px solid #eee;
				border-radius: 8px;
				height: 40px;
				box-sizing: border-box;
			}
			#done-btn {
				margin-left: 12px;
				color: #007aff;
				background: none;
				border: none;
				font-size: 18px;
				cursor: pointer;
				height: 40px;
				padding: 0 18px;
				border-radius: 8px;
				line-height: 40px;
			}
			#results-list {
				position: absolute;
				top: 64px;
				left: 0;
				width: 100vw;
				max-height: 250px;
				overflow-y: auto;
				background: #fff;
				z-index: 9;
				box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			}
			.result-item {
				padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
			}
			.result-item:last-child { border-bottom: none; }
			.result-item:hover { background: #f5f5f5; }
			#googleMap {
				position: absolute;
				top: 64px;
				left: 0;
				width: 100vw;
				bottom: 0;
				height: calc(100vh - 64px);
				z-index: 1;
			}
		</style>
	</head>
	<body>
		<div id="top-bar">
			<input type="text" id="search-input" placeholder="搜索位置" autocomplete="off" />
			<button id="done-btn">完成</button>
		</div>
		<div id="results-list" style="display:none;"></div>
		<div id="googleMap"></div>
		<script>
			let map, marker, placesService, geocoder;
			let resultsList = document.getElementById('results-list');
			let searchInput = document.getElementById('search-input');
			let doneBtn = document.getElementById('done-btn');
			let selectedPlace = null; // 记录选中的地点

			function onBack(data) {
				var timer = setInterval(function() {
					if (window.uni) {
						clearInterval(timer);
						uni.postMessage({ data: data });
						uni.navigateBack();
					}
				}, 10);
			}

			function initialize() {
				geocoder = new google.maps.Geocoder();
				let defaultLocation = { lat: 39.9042, lng: 116.4074 }; // 默认北京
				map = new google.maps.Map(document.getElementById("googleMap"), {
					center: defaultLocation,
					zoom: 12,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				});
				marker = new google.maps.Marker({ map: map });
				placesService = new google.maps.places.PlacesService(map);

				// 定位到当前位置
				if ("geolocation" in navigator) {
					navigator.geolocation.getCurrentPosition(function(position) {
						let latlng = {
							lat: position.coords.latitude,
							lng: position.coords.longitude
						};
						map.setCenter(latlng);
						marker.setPosition(latlng);
					});
				}
			}

			// 搜索地点
			function searchPlaces(query) {
				if (!query) {
					resultsList.style.display = 'none';
					resultsList.innerHTML = '';
					return;
				}
				let request = {
					input: query,
					location: map.getCenter(),
					radius: 50000
				};
				let autocompleteService = new google.maps.places.AutocompleteService();
				autocompleteService.getPlacePredictions(request, function(predictions, status) {
					if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
						resultsList.style.display = 'none';
						resultsList.innerHTML = '';
						return;
					}
					resultsList.innerHTML = '';
					predictions.forEach(function(pred) {
						let div = document.createElement('div');
						div.className = 'result-item';
						div.textContent = pred.description;
						div.onclick = function() {
							selectPlace(pred.place_id, pred.description);
						};
						resultsList.appendChild(div);
					});
					resultsList.style.display = 'block';
				});
			}

			// 选中某个地点
			function selectPlace(placeId, description) {
				placesService.getDetails({ placeId: placeId }, function(place, status) {
					if (status === google.maps.places.PlacesServiceStatus.OK) {
						let location = place.geometry.location;
						map.setCenter(location);
						map.setZoom(17);
						marker.setPosition(location);
						resultsList.style.display = 'none';
						resultsList.innerHTML = '';
						// 保存选中信息
						selectedPlace = {
							address: description,
							lat: location.lat(),
							lng: location.lng()
						};
					}
				});
			}

			// 完成按钮逻辑
			doneBtn.onclick = function() {
				if (selectedPlace) {
					onBack(selectedPlace);
				} else {
					// 没选则用输入框内容和当前地图中心
					let center = map.getCenter();
					onBack({
						address: searchInput.value.trim(),
						lat: center.lat(),
						lng: center.lng()
					});
				}
			};

			// 输入监听
			let searchTimer = null;
			searchInput.oninput = function() {
				clearTimeout(searchTimer);
				let val = searchInput.value.trim();
				searchTimer = setTimeout(function() {
					searchPlaces(val);
				}, 300);
			};

			// 初始化地图
			google.maps.event.addDomListener(window, 'load', initialize);
		</script>
	</body>
</html>
